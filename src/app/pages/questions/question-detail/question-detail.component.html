<div class="container question-detail-container">
  <!-- Back to questions link -->
  <div class="back-link mb-3">
    <a routerLink="/questions">
      <i class="pi pi-arrow-left"></i> Back to Questions
    </a>
  </div>

  <!-- Loading skeleton -->
  <div *ngIf="loading">
    <p-skeleton height="50px" styleClass="mb-2"></p-skeleton>
    <p-skeleton width="60%" height="24px" styleClass="mb-2"></p-skeleton>
    <p-skeleton height="120px" styleClass="mb-4"></p-skeleton>
    <p-divider></p-divider>
    <p-skeleton height="40px" styleClass="mb-2"></p-skeleton>
    <p-skeleton height="150px" styleClass="mb-4"></p-skeleton>
  </div>

  <!-- Question details -->
  <div *ngIf="!loading && question">
    <div class="question-header">
      <h1>{{ question.title }}</h1>
      <div class="question-meta">
        <span>Asked: {{ question.askedDate | date : "medium" }}</span>
      </div>
    </div>

    <p-divider></p-divider>

    <div class="question-content">
      <div class="row">
        <div class="col-md-1 col-sm-2 vote-controls">
          <div class="vote-buttons">
            <button
              class="vote-btn upvote"
              [ngClass]="{ active: question.userVote === 1 }"
              (click)="upvoteQuestion()"
            >
              <i class="pi pi-chevron-up"></i>
            </button>
            <div class="vote-count">{{ question.votes }}</div>
            <button
              class="vote-btn downvote"
              [ngClass]="{ active: question.userVote === -1 }"
              (click)="downvoteQuestion()"
            >
              <i class="pi pi-chevron-down"></i>
            </button>
          </div>
        </div>
        <div class="col-md-11 col-sm-10">
          <div class="question-body" [innerHTML]="question.body"></div>

          <div class="tags-container">
            <span *ngFor="let tag of question.tags" class="tag">{{ tag }}</span>
          </div>

          <div class="user-info">
            <div class="asked-by">
              <span>Asked by</span>
              <a href="javascript:void(0)">{{ question.askedBy }}</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="answers-section">
      <h2>
        {{ answers.length }} {{ answers.length === 1 ? "Answer" : "Answers" }}
      </h2>

      <div class="answers-list">
        <div *ngFor="let answer of answers" class="answer-item">
          <div class="row">
            <div class="col-md-1 col-sm-2 vote-controls">
              <div class="vote-buttons">
                <button
                  class="vote-btn upvote"
                  [ngClass]="{ active: answer.userVote === 1 }"
                  (click)="upvoteAnswer(answer.id)"
                >
                  <i class="pi pi-chevron-up"></i>
                </button>
                <div class="vote-count">{{ answer.votes }}</div>
                <button
                  class="vote-btn downvote"
                  [ngClass]="{ active: answer.userVote === -1 }"
                  (click)="downvoteAnswer(answer.id)"
                >
                  <i class="pi pi-chevron-down"></i>
                </button>
              </div>
            </div>
            <div class="col-md-11 col-sm-10">
              <div class="answer-body" [innerHTML]="answer.body"></div>

              <div class="user-info">
                <div class="answered-by">
                  <span>Answered by</span>
                  <a href="javascript:void(0)">{{ answer.answeredBy }}</a>
                  <span class="answered-date">{{
                    answer.answeredDate | date : "medium"
                  }}</span>
                </div>
              </div>

              <!-- Reply to answer button -->
              <div class="answer-actions">
                <button
                  class="reply-btn"
                  (click)="toggleReplyToAnswer(answer.id)"
                >
                  <i class="pi pi-reply"></i> Reply
                </button>
              </div>

              <!-- Reply to answer form -->
              <div *ngIf="replyingToAnswer === answer.id" class="reply-form">
                <textarea
                  [(ngModel)]="replyText"
                  placeholder="Write your reply..."
                  class="reply-textarea"
                  rows="3"
                ></textarea>
                <div class="reply-actions">
                  <button
                    pButton
                    label="Post Reply"
                    class="p-button-sm p-button-primary"
                    [disabled]="!replyText.trim()"
                    (click)="submitCommentToAnswer(answer.id)"
                  ></button>
                  <button
                    pButton
                    label="Cancel"
                    class="p-button-sm p-button-text"
                    (click)="cancelReply()"
                  ></button>
                </div>
              </div>

              <!-- Comments section -->
              <div
                *ngIf="getCommentsForAnswer(answer.id).length > 0"
                class="comments-section"
              >
                <ng-container
                  *ngFor="let comment of getCommentsForAnswer(answer.id)"
                >
                  <ng-container
                    *ngTemplateOutlet="
                      commentTemplate;
                      context: { $implicit: comment, level: 0 }
                    "
                  ></ng-container>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="your-answer-section">
      <h2>Your Answer</h2>

      <textarea
        [(ngModel)]="answerText"
        class="answer-textarea"
        placeholder="Write your answer here..."
        rows="10"
      ></textarea>

      <div class="mt-3">
        <button
          pButton
          label="Post Your Answer"
          class="p-button-primary"
          (click)="submitAnswer()"
          [disabled]="!answerText.trim()"
        ></button>
      </div>
    </div>
  </div>

  <!-- Error state -->
  <div *ngIf="!loading && !question" class="error-container">
    <p-message
      severity="error"
      text="Question not found"
      styleClass="w-full"
    ></p-message>
    <div class="mt-3">
      <button
        pButton
        label="Back to Questions"
        routerLink="/questions"
      ></button>
    </div>
  </div>
</div>

<!-- Comment template for recursion -->
<ng-template #commentTemplate let-comment let-level="level">
  <div class="comment-item" [style.margin-left.px]="level * 20">
    <div class="comment-container">
      <div class="comment-vote-controls">
        <button
          class="vote-btn upvote small"
          [ngClass]="{ active: comment.userVote === 1 }"
          (click)="upvoteComment(comment.id)"
        >
          <i class="pi pi-chevron-up"></i>
        </button>
        <div class="vote-count small">{{ comment.votes }}</div>
        <button
          class="vote-btn downvote small"
          [ngClass]="{ active: comment.userVote === -1 }"
          (click)="downvoteComment(comment.id)"
        >
          <i class="pi pi-chevron-down"></i>
        </button>
      </div>

      <div class="comment-content">
        <div class="comment-body" [innerHTML]="comment.body"></div>

        <div class="comment-meta">
          <span class="comment-author">{{ comment.commentedBy }}</span>
          <span class="comment-date">{{
            comment.commentedDate | date : "medium"
          }}</span>

          <button
            class="reply-btn-small"
            (click)="toggleReplyToComment(comment.id)"
          >
            <i class="pi pi-reply"></i> Reply
          </button>
        </div>

        <!-- Reply to comment form -->
        <div *ngIf="replyingToComment === comment.id" class="reply-form">
          <textarea
            [(ngModel)]="replyText"
            placeholder="Write your reply..."
            class="reply-textarea"
            rows="3"
          ></textarea>
          <div class="reply-actions">
            <button
              pButton
              label="Post Reply"
              class="p-button-sm p-button-primary"
              [disabled]="!replyText.trim()"
              (click)="submitCommentToComment(comment.id)"
            ></button>
            <button
              pButton
              label="Cancel"
              class="p-button-sm p-button-text"
              (click)="cancelReply()"
            ></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Recursively render child comments -->
    <div *ngIf="hasChildren(comment.id)" class="child-comments">
      <ng-container *ngFor="let childComment of getChildComments(comment.id)">
        <ng-container
          *ngTemplateOutlet="
            commentTemplate;
            context: { $implicit: childComment, level: level + 1 }
          "
        ></ng-container>
      </ng-container>
    </div>
  </div>
</ng-template>
